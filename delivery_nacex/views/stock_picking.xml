<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_picking_withcarrier_out_form_nacex" model="ir.ui.view">
        <field name="name">delivery.stock.picking_withcarrier.form.view.nacex</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="delivery.view_picking_withcarrier_out_form"/>
        <field name="arch" type="xml">
            <xpath expr="//group[@name='carrier_data']" position="inside">
                <field name="etiqueta_envio_zpl"/>
                <field name="bultos"/>
                <field name="picking_contenedor"/>
            </xpath>
        </field>
    </record>
    
    <!--
        'Envio valija' in action dropdown
    -->
    <record id="action_envio_valija" model="ir.actions.server">
        <field name="name">Envio valija</field>
        <field name="model_id" ref="model_stock_picking"/>
        <field name="binding_model_id" ref="stock.model_stock_picking"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
if records:
    partner = False
    nacex_valija = env.ref('delivery_nacex.delivery_carrier_nacex_valija')
    for albaran in records:
        if albaran.state != 'done':
          raise UserError("Todos los albaranes deben estar realizados")
        if albaran.carrier_id != nacex_valija:
          raise UserError("Todos los albaranes deben tener como método de envío Nacex valija")
        if albaran.partner_id != partner and partner:
          raise UserError("Todos los albaranes deben tener la misma dirección de entrega")
        partner = albaran.partner_id
    action_values = env.ref('delivery_nacex.envio_valija_action').sudo().read()[0]
    action_values.update({'context': env.context})
    action = action_values
        </field>
    </record>
</odoo>
